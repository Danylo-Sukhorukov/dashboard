name: Multi-repo Release

on:
  workflow_dispatch:
    inputs:
      from:
        description: "Source branch (e.g. dev)"
        required: true
        default: "dev"
      to:
        description: "Target branch (e.g. test)"
        required: true
        default: "test"
      mode:
        description: "Execution mode"
        required: true
        type: choice
        options:
          - dry-run
          - apply

permissions:
  contents: write
  pull-requests: write

jobs:
  compare:
    name: Compare branches
    runs-on: ubuntu-latest

    outputs:
      affected: ${{ steps.collect.outputs.affected }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq

      - name: Compare repositories
        id: collect
        env:
          GH_TOKEN: ${{ secrets.CROSS_REPO_TOKEN }}
        run: |
          echo "[]" > affected.json

          for row in $(jq -c '.[]' services.json); do
            name=$(echo "$row" | jq -r '.name')
            repo=$(echo "$row" | jq -r '.repo')

            echo "$repo"

            ahead=$(gh api repos/$repo/compare/${{ inputs.to }}...${{ inputs.from }} \
              --jq '.ahead_by' 2>/dev/null || echo "0")

            if [ "$ahead" -gt 0 ]; then
              jq ". + [{\"name\":\"$name\",\"repo\":\"$repo\",\"ahead\":$ahead}]" \
                affected.json > tmp.json && mv tmp.json affected.json
            fi
          done

          echo "affected=$(jq -c . affected.json)" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "##Release comparison" >> $GITHUB_STEP_SUMMARY
          echo "**From:** \`${{ inputs.from }}\` → **To:** \`${{ inputs.to }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$(jq length affected.json)" -eq 0 ]; then
            echo "No repositories require release" >> $GITHUB_STEP_SUMMARY
          else
            jq -r '.[] | "- **\(.name)** (`\(.repo)`) +\(.ahead)"' affected.json \
              >> $GITHUB_STEP_SUMMARY
          fi

  apply:
    name: Create release PRs
    needs: compare
    if: inputs.mode == 'apply' && needs.compare.outputs.affected != '[]'
    runs-on: ubuntu-latest

    environment:
      name: release-approval

    steps:
      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq

      - name: Create PRs
        env:
          GH_TOKEN: ${{ secrets.CROSS_REPO_TOKEN }}
          AFFECTED: ${{ needs.compare.outputs.affected }}
        run: |
          echo "[]" > prs.json

          for svc in $(echo "$AFFECTED" | jq -c '.[]'); do
            repo=$(echo "$svc" | jq -r '.repo')
            name=$(echo "$svc" | jq -r '.name')

            echo "Creating PR for $repo"

            output=$(gh pr create \
              --repo "$repo" \
              --base "${{ inputs.to }}" \
              --head "${{ inputs.from }}" \
              --title "Release ${{ inputs.from }} → ${{ inputs.to }}" \
              --body "Automated release PR for **$name**" \
              2>&1)

            echo "$output"

            pr_url=$(echo "$output" | grep -Eo 'https://github.com[^ ]+')

            if [ -n "$pr_url" ]; then
              jq ". + [{\"name\":\"$name\",\"repo\":\"$repo\",\"url\":\"$pr_url\"}]" \
                prs.json > tmp.json && mv tmp.json prs.json
            fi
          done

      - name: Summary
        run: |
          echo "## Release PRs created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$(jq length prs.json)" -eq 0 ]; then
            echo "No PRs were created" >> $GITHUB_STEP_SUMMARY
          else
            jq -r '.[] | "- **\(.name)** (`\(.repo)`) → [PR link](\(.url))"' prs.json \
              >> $GITHUB_STEP_SUMMARY
          fi
