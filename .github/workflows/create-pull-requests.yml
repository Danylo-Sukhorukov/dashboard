name: Promote branches (Create PRs)

on:
  workflow_dispatch:
    inputs:
      from:
        description: Source branch (dev / test / stage)
        required: true
        type: choice
        options:
          - dev
          - test
          - stage

      to:
        description: Target branch (test / stage / prod)
        required: true
        type: choice
        options:
          - test
          - stage
          - prod

      services:
        description: >
          Comma-separated repositories (owner/repo).
          Example: danylo-sukhorukov/service1,danylo-sukhorukov/service2
        required: true

      auto_merge:
        description: Auto-merge PRs if possible (true / false)
        required: false
        default: "false"

permissions:
  contents: write
  pull-requests: write

jobs:
  create-prs:
    runs-on: ubuntu-latest

    steps:
      - name: Show inputs (debug)
        run: |
          echo "FROM = ${{ inputs.from }}"
          echo "TO = ${{ inputs.to }}"
          echo "SERVICES = ${{ inputs.services }}"
          echo "AUTO_MERGE = ${{ inputs.auto_merge }}"

      - name: Create Pull Requests
        env:
          GH_TOKEN: ${{ secrets.CROSS_REPO_TOKEN }}
          FROM: ${{ inputs.from }}
          TO: ${{ inputs.to }}
          SERVICES: ${{ inputs.services }}
        run: |
          set -e

          echo "Starting PR creation: $FROM → $TO"
          echo "Services: $SERVICES"
          echo

          # Разбиваем CSV в массив
          IFS=',' read -ra REPOS <<< "$SERVICES"

          for repo in "${REPOS[@]}"; do
            repo="$(echo "$repo" | xargs)"

            if [ -z "$repo" ]; then
              echo "Skipping empty repo entry"
              continue
            fi

            echo "--------------------------------------------------"
            echo "Creating PR for $repo"

            gh pr create \
              --repo "$repo" \
              --base "$TO" \
              --head "$FROM" \
              --title "Promote $FROM → $TO" \
              --body "Automated promotion via release-dashboard" \
              || echo "PR already exists or cannot be created for $repo"
          done

      - name: Auto-merge Pull Requests (optional)
        if: inputs.auto_merge == 'true'
        env:
          GH_TOKEN: ${{ secrets.CROSS_REPO_TOKEN }}
          FROM: ${{ inputs.from }}
          TO: ${{ inputs.to }}
          SERVICES: ${{ inputs.services }}
        run: |
          set -e

          echo "Auto-merge enabled"
          IFS=',' read -ra REPOS <<< "$SERVICES"

          for repo in "${REPOS[@]}"; do
            repo="$(echo "$repo" | xargs)"
            [ -z "$repo" ] && continue

            echo "---------------------------------------------"
            echo "Looking for PR in $repo ($FROM → $TO)"

            # Ищем PR
            PR_NUMBER=$(gh pr list \
              --repo "$repo" \
              --base "$TO" \
              --head "$FROM" \
              --state open \
              --json number \
              --jq '.[0].number')

            if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" = "null" ]; then
              echo "No open PR found for $repo"
              continue
            fi

            echo "Found PR #$PR_NUMBER — attempting auto-merge"

            gh pr merge "$PR_NUMBER" \
              --repo "$repo" \
              --auto \
              --squash \
              || echo "Auto-merge not possible for $repo (checks/approvals pending)"
          done

