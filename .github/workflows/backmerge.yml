name: Backmerge PR

on:
  workflow_dispatch:
    inputs:
      source_branch:
        description: 'Source branch (from)'
        required: true
        default: 'prod'
        type: string

      target_branch:
        description: 'Target branch (to)'
        required: true
        default: 'stage'
        type: string

      repositories:
        description: |
          Repositories (one per line, format: owner/repo)
          Example:
          my-org/service-a
          my-org/service-b
        required: true
        type: string

      draft:
        description: 'Create PRs as draft'
        required: false
        default: true
        type: boolean

jobs:
  backmerge:
    runs-on: ubuntu-latest

    steps:
      - name: Validate input
        run: |
          if [ "${{ inputs.source_branch }}" = "${{ inputs.target_branch }}" ]; then
            echo "Source and target branches must be different"
            exit 1
          fi

      - name: Authenticate gh
        env:
          GH_TOKEN: ${{ secrets.CROSS_REPO_TOKEN }}
        run: |
          gh auth status

      - name: Create backmerge PRs
        env:
          GH_TOKEN: ${{ secrets.CROSS_REPO_TOKEN }}
        run: |
          set -e

          SOURCE="${{ inputs.source_branch }}"
          TARGET="${{ inputs.target_branch }}"
          DRAFT="${{ inputs.draft }}"
          REPOS=$(echo "${{ inputs.repositories }}" | tr -d '\r')

          echo "Backmerge: $SOURCE → $TARGET"
          echo "Repositories:"
          echo "$REPOS"
          echo "-------------------------"

          for REPO in $REPOS; do
            echo ""
            echo "▶ Processing $REPO"

            COMMITS=$(gh api \
              repos/$REPO/compare/$TARGET...$SOURCE \
              --jq '.total_commits')

            if [ "$COMMITS" = "0" ]; then
              echo "No commits to backmerge"
              continue
            fi

            EXISTING_PR=$(gh pr list \
              --repo "$REPO" \
              --base "$TARGET" \
              --head "$SOURCE" \
              --state open \
              --json number \
              --jq 'length')

            if [ "$EXISTING_PR" != "0" ]; then
              echo "PR already exists"
              continue
            fi

            gh pr create \
              --repo "$REPO" \
              --base "$TARGET" \
              --head "$SOURCE" \
              --title "chore: backmerge $SOURCE → $TARGET" \
              --body "Automated backmerge PR

            From: \`$SOURCE\`
            To: \`$TARGET\`
            
            Created via GitHub Actions." \
                          $( [ "$DRAFT" = "true" ] && echo "--draft" )
            
                        echo "PR created"
                      done
