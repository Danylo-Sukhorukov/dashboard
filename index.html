<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Release Dashboard</title>
  <style>
    body {
      font-family: sans-serif;
      background: white;
      padding: 40px;
    }
    label, button {
      display: block;
      margin-top: 20px;
    }
  </style>
</head>
<body>

<h1>Create release</h1>

<label>
  Release date:
  <input type="date" id="releaseDate" />
</label>

<button onclick="createRelease()">Create release</button>

  <h2>Services</h2>

<table border="1" cellpadding="8">
  <thead>
    <tr>
      <th>Service</th>
      <th>Branch</th>
      <th>Commit</th>
      <th>CI</th>
    </tr>
  </thead>
  <tbody id="services"></tbody>
</table>

<script>
function formatDate(dateStr) {
  const d = new Date(dateStr);
  const dd = String(d.getDate()).padStart(2, '0');
  const mm = String(d.getMonth() + 1).padStart(2, '0');
  const yyyy = d.getFullYear();
  return `${dd}-${mm}-${yyyy}`;
}

async function createRelease() {
  const dateInput = document.getElementById('releaseDate').value;
  if (!dateInput) {
    alert('Please select a date');
    return;
  }

  const releaseName = formatDate(dateInput);

  await fetch(
    "https://api.github.com/repos/<OWNER>/release-dashboard/actions/workflows/create-release.yml/dispatches",
    {
      method: "POST",
      headers: {
        "Accept": "application/vnd.github+json",
        "Authorization": "token <TEMP_PAT>"
      },
      body: JSON.stringify({
        ref: "main",
        inputs: {
          release: releaseName
        }
      })
    }
  );

  alert(`Release release/${releaseName} triggered`);
}
</script>

  <script>
async function loadServices() {
  const res = await fetch('./services.json');
  const services = await res.json();

  for (const svc of services) {
    await renderService(svc);
  }
}

async function renderService(service) {
  const tbody = document.getElementById('services');

  const [owner, repo] = service.repo.split('/');
  const branch = service.deployBranch;

  const branchRes = await fetch(
    `https://api.github.com/repos/${owner}/${repo}/branches/${branch}`
  );
  const branchData = await branchRes.json();

  const sha = branchData.commit.sha.slice(0, 7);

  const statusRes = await fetch(
    `https://api.github.com/repos/${owner}/${repo}/commits/${branchData.commit.sha}/status`
  );
  const statusData = await statusRes.json();

  const state = statusData.state;

  const row = document.createElement('tr');
  row.innerHTML = `
    <td>${service.name}</td>
    <td>${branch}</td>
    <td>${sha}</td>
    <td>${renderStatus(state)}</td>
  `;
  tbody.appendChild(row);
}

function renderStatus(state) {
  switch (state) {
    case 'success': return 'success';
    case 'pending': return 'running';
    case 'failure': return 'failed';
    default: return 'unknown';
  }
}

loadServices();
</script>


</body>
</html>
